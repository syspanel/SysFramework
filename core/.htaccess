<?php

namespace Core;

class SysTE
{
    protected $viewsPath;
    protected $cachePath;
    protected $sections = [];
    protected $extends = null;
    protected $pushStack = [];
    protected $currentSection = null;
    protected $currentPush = null;

    public function __construct($viewsPath, $cachePath)
    {
        $this->viewsPath = $viewsPath;
        $this->cachePath = $cachePath;
    }

    public function render($template, $data = [])
    {
        $templatePath = $this->viewsPath . '/' . str_replace('.', '/', $template) . '.blade.php';
        $cachePath = $this->cachePath . '/' . md5($template) . '.php';

        if (!file_exists($templatePath)) {
            throw new \Exception("Template nÃ£o encontrado: " . $templatePath);
        }

        if (!file_exists($cachePath) || filemtime($templatePath) > filemtime($cachePath)) {
            $this->compile($templatePath, $cachePath);
        }

        ob_start();
        extract($data);
        include $cachePath;
        return ob_get_clean();
    }

    protected function compile($templatePath, $cachePath)
    {
        $content = file_get_contents($templatePath);

        $content = $this->compileIfStatements($content);
        $content = $this->compileForeachStatements($content);
        $content = $this->compileForStatements($content);
        $content = $this->compilePhpStatements($content);
        $content = $this->compileAdditionalDirectives($content);

        file_put_contents($cachePath, $content);
    }

    protected function compileIfStatements($content)
    {
        $patterns = [
            '/{{--(.*?)--}}/s' => '',
            '/@if\s*\((.*?)\)/s' => '<?php if ($1): ?>',
            '/@else\s*/s' => '<?php else: ?>',
            '/@elseif\s*\((.*?)\)/s' => '<?php elseif ($1): ?>',
            '/@endif\s*/s' => '<?php endif; ?>',
        ];
        return preg_replace(array_keys($patterns), array_values($patterns), $content);
    }

    protected function compileForeachStatements($content)
    {
        $patterns = [
            '/@foreach\s*\((.*?)\)/s' => '<?php foreach ($1): ?>',
            '/@endforeach\s*/s' => '<?php endforeach; ?>',
        ];
        return preg_replace(array_keys($patterns), array_values($patterns), $content);
    }

    protected function compileForStatements($content)
    {
        $patterns = [
            '/@for\s*\((.*?)\)/s' => '<?php for ($1): ?>',
            '/@endfor\s*/s' => '<?php endfor; ?>',
        ];
        return preg_replace(array_keys($patterns), array_values($patterns), $content);
    }

    protected function compilePhpStatements($content)
    {
        $patterns = [
            '/@php\s*(.*?)@endphp/s' => '<?php $1 ?>',
            '/{{\s*(.*?)\s*}}/s' => '<?php echo htmlspecialchars($1, ENT_QUOTES, "UTF-8"); ?>',
            '/@{{\s*(.*?)\s*}}/s' => '{{ $1 }}',
        ];
        return preg_replace(array_keys($patterns), array_values($patterns), $content);
    }

    protected function compileAdditionalDirectives($content)
    {
        $patterns = [
            '/@extends\s*\(\s*[\'"]([^\'"]+)[\'"]\s*\)/s' => '<?php echo $this->extend(\'$1\'); ?>',
            '/@section\s*\(\s*[\'"]([^\'"]+)[\'"]\s*,\s*[\'"]([^\'"]+)[\'"]\s*\)/s' => '<?php $this->startSection(\'$1\', \'$2\'); ?>',
            '/@endsection\s*/s' => '<?php $this->stopSection(); ?>',
            '/@yield\s*\(\s*[\'"]([^\'"]+)[\'"]\s*\)/s' => '<?php echo $this->yieldSection(\'$1\'); ?>',
            '/@include\s*\(\s*[\'"]([^\'"]+)[\'"]\s*\)/s' => '<?php echo $this->include(\'$1\'); ?>',
            '/@includeIf\s*\(\s*[\'"]([^\'"]+)[\'"]\s*\)/s' => '<?php echo $this->includeIf(\'$1\'); ?>',
            '/@includeWhen\s*\(\s*(.*?)\s*,\s*[\'"]([^\'"]+)[\'"]\s*\)/s' => '<?php echo $this->includeWhen($1, \'$2\'); ?>',
            '/@includeUnless\s*\(\s*(.*?)\s*,\s*[\'"]([^\'"]+)[\'"]\s*\)/s' => '<?php echo $this->includeUnless($1, \'$2\'); ?>',
            '/@push\s*\(\s*[\'"]([^\'"]+)[\'"]\s*\)/s' => '<?php $this->startPush(\'$1\'); ?>',
            '/@endpush\s*/s' => '<?php $this->stopPush(); ?>',
            '/@stack\s*\(\s*[\'"]([^\'"]+)[\'"]\s*\)/s' => '<?php echo $this->stack(\'$1\'); ?>',
        ];
        return preg_replace(array_keys($patterns), array_values($patterns), $content);
    }

    public function extend($template)
    {
        $this->extends = $template;
        return ''; // Ensures that `@extends` does not output anything
    }

    public function startSection($name, $content = '')
    {
        $this->currentSection = $name;
        ob_start();
        if ($content) {
            echo $content;
        }
    }

    public function stopSection()
    {
        if ($this->currentSection) {
            $this->sections[$this->currentSection] = ob_get_clean();
            $this->currentSection = null;
        }
    }

    public function yieldSection($name)
    {
        return isset($this->sections[$name]) ? $this->sections[$name] : '';
    }

    public function include($template)
    {
        return $this->render($template);
    }

    public function includeIf($template)
    {
        $templatePath = $this->viewsPath . '/' . str_replace('.', '/', $template) . '.blade.php';
        if (file_exists($templatePath)) {
            return $this->render($template);
        }
        return '';
    }

    public function includeWhen($condition, $template)
    {
        return $condition ? $this->include($template) : '';
    }

    public function includeUnless($condition, $template)
    {
        return !$condition ? $this->include($template) : '';
    }

    public function startPush($name)
    {
        ob_start();
        $this->currentPush = $name;
        if (!isset($this->pushStack[$name])) {
            $this->pushStack[$name] = [];
        }
    }

    public function stopPush()
    {
        if ($this->currentPush) {
            $this->pushStack[$this->currentPush][] = ob_get_clean();
            $this->currentPush = null;
        }
    }

    public function stack($name)
    {
        if (!isset($this->pushStack[$name])) {
            return '';
        }
        return implode('', array_merge(...$this->pushStack[$name]));
    }
}
